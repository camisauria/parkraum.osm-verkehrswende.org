---
title: Karte aus dem Projekt "Vector Tiles"
layout: default
noindex: true
menu_highlight: project_vector_tiles_map
menu_scroll: true
---

<link rel="stylesheet" href="{{ '/css/maplibre-gl.css' | relative_url }}" />
<script src="{{ 'javascript/maplibre-gl.js' | relative_url }}"></script>

<div class="flex h-full gap-5">
  <div id="map" class="w-100 relative h-full flex-1">
    {% include map/buttons.html %}
  </div>

  <div
    id="legend"
    class="vh-100 prose-sm prose-blue absolute inset-x-0 bottom-0 z-1000 hidden h-72 overflow-scroll bg-white px-5 shadow-2xl md:static md:block md:h-auto md:w-60 md:overscroll-auto md:px-0 md:shadow-none"
    data-show-hide-target="legend"
  ></div>
</div>

<script>
  var map = new maplibregl.Map({
    container: "map",
    style:
      "https://api.maptiler.com/maps/pastel/style.json?key=lh0zCEEmjlKmX91QQEAU",
    zoom: 16,
    center: [13.4381, 52.47928],
    hash: true,
    attributionControl: true,
    customAttribution: "Parkraumdaten auf OSM-Basis",
  });

  map.on("load", function () {
    // Add Mapillary sequence layer.
    // https://www.mapillary.com/developer/tiles-documentation/#sequence-layer
    map.addSource("vts_pl_tiles", {
      type: "vector",
      tiles: [
        "https://vts.mapwebbing.eu/public.parking_segments/{z}/{x}/{y}.pbf",
      ],
      minzoom: 8,
      maxzoom: 22,
    });

    map.addSource("vts_boundaries_tiles", {
      type: "vector",
      tiles: ["https://vts.mapwebbing.eu/public.boundaries/{z}/{x}/{y}.pbf"],
      minzoom: 8,
      maxzoom: 22,
    });

    map.addLayer({
      id: "vts_boundaries",
      type: "line",
      source: "vts_boundaries_tiles",
      "source-layer": "public.boundaries",
      filter: ["all", [">=", "admin_level", "'10'"]],
      paint: {
        "line-width": 2,
        "line-color": "rgba(215, 34, 34, 1)",
      },
    });

    map.addLayer({
      id: "vts_pl",
      type: "line",
      source: "vts_pl_tiles",
      "source-layer": "public.parking_segments",
      filter: [
        "all",
        [
          "in",
          "orientation",
          "half_on_kerb",
          "marked",
          "mixed",
          "parallel",
          "perpendicular",
          "street_side",
          "yes",
          "diagonal",
        ],
      ],
      paint: { "line-width": 4, "line-color": "rgba(110, 165, 9, 1)" },
    });

    map.addLayer({
      id: "vts_pl_no",
      type: "line",
      source: "vts_pl_tiles",
      "source-layer": "public.parking_segments",
      filter: ["all", ["in", "orientation", "no", "no_parking", "no_stopping"]],
      paint: { "line-width": 2, "line-color": "rgba(233, 171, 148, 1)" },
    });

    map.addLayer({
      id: "vts_pl_all_other",
      type: "line",
      source: "vts_pl_tiles",
      "source-layer": "public.parking_segments",
      filter: [
        "all",
        [
          "!in",
          "orientation",
          "no",
          "no_parking",
          "no_stopping",
          "separate",
          "half_on_kerb",
          "marked",
          "mixed",
          "parallel",
          "perpendicular",
          "street_side",
          "yes",
          "diagonal",
        ],
      ],
      paint: { "line-width": 3, "line-color": "rgba(153, 164, 241, 1)" },
    });

    map.addLayer({
      id: "vts_pl_label",
      type: "symbol",
      source: "vts_pl_tiles",
      "source-layer": "public.parking_segments",
      layout: {
        "text-field": "{capacity}",
        "symbol-placement": "line-center",
      },
      paint: {
        "text-halo-color": "rgba(255, 255, 255, 1)",
        "text-halo-width": 1,
      },
    });
  });

  map.addControl(new maplibregl.NavigationControl());

  map.on("load", () => {
    const vts_pl_layers = map
      .getStyle()
      .layers.filter((layer) => layer.id.startsWith("vts_pl"));

    // For all `vts_pl_*` layers…
    vts_pl_layers.forEach((layer) => {
      // … change the cursor
      map.on("mouseenter", layer.id, () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", layer.id, () => {
        map.getCanvas().style.cursor = "";
      });

      // … show features as table in legend
      map.on("mousemove", layer.id, (event) => {
        const features = map.queryRenderedFeatures(event.point);

        // Collect key-value data
        // Will return multiple sets if the mouse hovers more than one…
        const displayFeatures = features
          .filter((f) => f.source == "vts_pl_tiles")
          .map((f) => f.properties);

        // Show legend with table of key-value data
        if (displayFeatures.length) {
          const table = displayFeatures
            .map(
              (line) => `<table class="w-full prose-sm">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="text-left py-0.5 pl-0.5">key</th>
                    <th class="text-left py-0.5 pl-1">value</th>
                  </tr>
                </thead>
                <tbody>
                  ${Object.entries(line)
                    .map(
                      ([key, value]) => `
                    <tr class="border-b border-gray-200">
                      <td class="break-all w-1/2 p-0"><code>${key}</code></td>
                      <td class="break-all w-1/2 p-0 pl-1">
                        <code>${value}</code>
                        ${
                          key === "way_id"
                            ? `<a href="https://www.openstreetmap.org/way/${
                                value.split(".")[0]
                              }" target="_blank" class="underline hover:text-blue-500">OSM</a>`
                            : ""
                        }
                      </td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>`
            )
            .join("");
          document.getElementById("legend").innerHTML = table;
        }
      });
    });
  });

  map.on("load", () => {
    // Now for a list of background layers
    // Docs .addSource: https://maplibre.org/maplibre-gl-js-docs/api/map/#map#addsource
    //    https://maplibre.org/maplibre-gl-js-docs/style-spec/sources/#raster
    // Docs .addLayer: https://maplibre.org/maplibre-gl-js-docs/api/map/#map#addlayer
    //    https://maplibre.org/maplibre-gl-js-docs/style-spec/layers/#raster

    const afterThisLayer = "vts_boundaries";

    map.addSource("strasssenbefahrung_tiles", {
      type: "raster",
      tiles: [
        "https://mapproxy.codefor.de/tiles/1.0.0/strassenbefahrung/mercator/{z}/{x}/{y}.png",
      ],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a target="blank" href="https://fbinter.stadt-berlin.de/fb/berlin/service_intern.jsp?id=k_StraDa@senstadt&type=WMS">Geoportal Berlin / Straßenbefahrung 2014</a>',
    });
    map.addLayer(
      {
        id: "strasssenbefahrung",
        type: "raster",
        source: "strasssenbefahrung_tiles",
        visibility: "none",
      },
      afterThisLayer
    );

    map.addSource("alkis_tiles", {
      type: "raster",
      tiles: [
        "https://mapproxy.codefor.de/tiles/1.0.0/alkis_30/mercator/{z}/{x}/{y}.png",
      ],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a target="blank" href="https://fbinter.stadt-berlin.de/fb/berlin/service_intern.jsp?id=k_StraDa@senstadt&type=WMS">Geoportal Berlin / Straßenbefahrung 2014</a>',
    });
    map.addLayer(
      {
        id: "alkis",
        type: "raster",
        source: "alkis_tiles",
        visibility: "none",
      },
      afterThisLayer
    );

    map.addSource("mapnik_tiles", {
      type: "raster",
      tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
    });
    map.addLayer(
      {
        id: "mapnik",
        type: "raster",
        source: "mapnik_tiles",
      },
      afterThisLayer
    );

    map.addSource("esri_tiles", {
      type: "raster",
      tiles: [
        "https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      ],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a href="https://wiki.openstreetmap.org/wiki/Esri">Terms & Feedback</a>',
    });
    map.addLayer(
      {
        id: "esri",
        type: "raster",
        source: "esri_tiles",
      },
      afterThisLayer
    );

    map.addSource("maxar_tiles", {
      type: "raster",
      tiles: [
        "https://services.digitalglobe.com/earthservice/tmsaccess/tms/1.0.0/DigitalGlobe:ImageryTileService@EPSG:3857@jpg/{z}/{x}/{-y}.jpg?connectId=fa014fbc-6cbe-4b6f-b0ca-fbfb8d1e5b7d",
      ],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        "<a href='https://wiki.openstreetmap.org/wiki/DigitalGlobe'>Terms & Feedback</a>",
    });
    map.addLayer(
      {
        id: "maxar",
        type: "raster",
        source: "maxar_tiles",
      },
      "vts_boundaries"
    );

    map.addLayer(
      {
        id: "esri",
        type: "raster",
        source: "esri_tiles",
      },
      "vts_boundaries"
    );

    map.addSource("areal2021_tiles", {
      type: "raster",
      tiles: ["https://tiles.codefor.de/berlin-2021-dop20rgbi/{z}/{x}/{y}.png"],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a target="blank" href="https://fbinter.stadt-berlin.de/fb/berlin/service.jsp?id=a_luftbild2021_rgb@senstadt&type=FEED">Geoportal Berlin / Digitale farbige Orthophotos 2021 (DOP20RGBI)</a>',
    });
    map.addLayer(
      {
        id: "areal2021",
        type: "raster",
        source: "areal2021_tiles",
      },
      afterThisLayer
    );

    map.addSource("areal2020_tiles", {
      type: "raster",
      tiles: ["https://tiles.codefor.de/berlin-2020-dop20rgb/{z}/{x}/{y}.png"],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a target="blank" href="https://fbinter.stadt-berlin.de/fb/berlin/service.jsp?id=a_luftbild2020_rgb@senstadt&type=FEED">Geoportal Berlin / Digitale farbige Orthophotos 2020 (DOP20RGB)</a>',
    });
    map.addLayer(
      {
        id: "areal2020",
        type: "raster",
        source: "areal2020_tiles",
      },
      afterThisLayer
    );

    map.addSource("areal2019_tiles", {
      type: "raster",
      tiles: ["https://tiles.codefor.de/berlin-2019-dop20rgb/{z}/{x}/{y}.png"],
      tileSize: 256,
      minzoom: 10,
      maxzoom: 21,
      attribution:
        '<a target="blank" href="https://fbinter.stadt-berlin.de/fb/berlin/service.jsp?id=a_luftbild2019_rgb@senstadt&type=FEED">Geoportal Berlin / Digitale farbige Orthophotos 2019 (DOP20RGB)</a>',
    });
    map.addLayer(
      {
        id: "areal2019",
        type: "raster",
        source: "areal2019_tiles",
      },
      afterThisLayer
    );

    // Docs https://docs.mapbox.com/api/maps/static-tiles/
    // Edit Style https://studio.mapbox.com/styles/hejco/ckz8bsqbq000t15nz6ok45bid/edit/#15.61/52.495655/13.417375
    // TODO: Lizenz / Attribution
    // About Quota: Make sure we only pull data where avaliable and only for zoom level that are usefull.
    //  Quota at: https://account.mapbox.com/
    //  Docs: https://docs.mapbox.com/api/maps/static-tiles/#manage-static-tiles-api-costs
    map.addSource("xhainGutachten_tiles", {
      type: "raster",
      tiles: [
        "https://api.mapbox.com/styles/v1/hejco/ckz8bsqbq000t15nz6ok45bid/tiles/512/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaGVqY28iLCJhIjoiY2piZjd2bzk2MnVsMjJybGxwOWhkbWxpNCJ9.L1UNUPutVJHWjSmqoN4h7Q",
      ],
      tileSize: 512,
      minzoom: 18, // Quota
      maxzoom: 21,
      //     bounds: L.latLngBounds(L.latLng(52.5310256, 13.4914434), L.latLng(52.4827923, 13.3682291)), // Quota (outside no data is loaded for this layer)
      attribution:
        "Daten der Parkraumgutachten der Bezirksverwaltung. OpenData. Lizenz TODO.",
    });
    map.addLayer(
      {
        id: "xhainGutachten",
        type: "raster",
        source: "xhainGutachten_tiles",
      },
      afterThisLayer
    );
  });

  // Buttons to show/hide layer https://docs.mapbox.com/mapbox-gl-js/example/toggle-layers/
  // After the last frame rendered before the map enters an "idle" state.
  map.on("idle", () => {
    // Enumerate ids of the layers.
    const toggleableLayerIds = [
      "strasssenbefahrung",
      "alkis",
      "mapnik",
      "esri",
      "maxar",
      "esri",
      "areal2021",
      "areal2020",
      "areal2019",
      "xhainGutachten",
    ];

    // But we only work with those layers, that where added to the map
    const toggleExistingLayerIds = toggleableLayerIds.filter((layerId) =>
      map.getLayer(layerId)
    );

    // Set up the corresponding toggle button for each layer.
    for (const id of toggleExistingLayerIds) {
      // Skip layers that already have a button set up.
      if (document.getElementById(id)) {
        continue;
      }

      // Hide all layer by default:
      map.setLayoutProperty(id, "visibility", "none");

      // Add button:
      const classesShared =
        "flex items-center justify-center rounded border border-gray-300 bg-white px-1.5 py-0.5 text-xs font-medium !text-gray-700 shadow-sm ring-2 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500";
      const classesActive = classesShared + " ring-blue-400/40";
      const classesInactive = classesShared + " ring-gray-400/40";

      // Create a link.
      const link = document.createElement("button");
      link.id = id;
      link.type = "button";
      link.textContent = id;
      link.className = classesActive;

      // Show or hide layer when the toggle is clicked.
      link.onclick = function (e) {
        const clickedLayer = this.id;
        const visibility = map.getLayoutProperty(clickedLayer, "visibility");

        // Toggle layer visibility by changing the layout object's visibility property.
        // Default is invisible
        if (visibility === "none") {
          this.className = classesActive;
          // Hide all layers
          toggleExistingLayerIds.forEach((layerId) => {
            map.setLayoutProperty(clickedLayer, "visibility", "none");
          });
          // Show the clicked layer
          map.setLayoutProperty(clickedLayer, "visibility", "visible");
        } else {
          this.className = classesInactive;
          map.setLayoutProperty(clickedLayer, "visibility", "none");
        }
      };

      const layers = document.getElementById("layer");
      layers.appendChild(link);
    }
  });
</script>
